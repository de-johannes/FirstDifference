name: Release CI (main only)

on:
  push:
    branches:
      - main
    paths:
      - 'DRIFE.agda'
      - 'proofs/*.py'
      - 'proofs/*.agda'
      - 'README.md'
      - '.github/workflows/release-ci.yml'

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  verify:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Agda
        uses: wenkokke/setup-agda@v2
        with:
          agda-version: '2.7.0.1'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: pip install numpy

      - name: Compile DRIFE.agda
        run: |
          echo "ðŸš€ Compiling DRIFE.agda for release verification..."
          agda --safe --without-K --no-libraries DRIFE.agda
          echo "âœ… DRIFE.agda compiled successfully!"

      - name: Check for holes
        run: |
          echo "ðŸ” Checking for holes {!!}..."
          if grep -n '{!.*!}' DRIFE.agda; then
            echo "âŒ Holes found - cannot release!"
            exit 1
          else
            echo "âœ… No holes found!"
          fi

      - name: Run Kâ‚„ validation
        run: |
          echo "ðŸ§® Running validate_K4.py..."
          python proofs/validate_K4.py
          echo "âœ… Kâ‚„ tests passed!"

      - name: Run Î± validation
        run: |
          echo "ðŸ§® Running validate_alpha.py..."
          python proofs/validate_alpha.py
          echo "âœ… Î± tests passed!"

      - name: Run Î› validation
        run: |
          echo "ðŸ§® Running validate_lambda.py..."
          python proofs/validate_lambda.py
          echo "âœ… Î› tests passed!"

      - name: Run cosmic age validation
        run: |
          echo "ðŸ§® Running validate_cosmic_age.py..."
          python proofs/validate_cosmic_age.py
          echo "âœ… Cosmic age tests passed!"

  release:
    name: Create release on success
    needs: verify
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute SHORT_SHA
        id: sha
        run: echo "short=${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"

      - name: Fetch tags
        run: git fetch --tags --force

      - name: Compute changelog
        id: changelog
        shell: bash
        run: |
          set -euo pipefail
          PREV_TAG="$(git describe --tags --abbrev=0 2>/dev/null || true)"
          echo "prev=${PREV_TAG}" >> "$GITHUB_OUTPUT"
          
          {
            echo "## DRIFE Release ${{ steps.sha.outputs.short }}"
            echo ""
            echo "ðŸ† **The First Distinction â†’ Einstein Field Equations**"
            echo ""
            echo "### KÃ¶nigsklasse Predictions (zero free parameters):"
            echo "- d = 3 (from Kâ‚„ eigenvalue degeneracy)"
            echo "- Î› > 0 (from finite Kâ‚„)"
            echo "- Îº = 8 (from edge/vertex ratio)"
            echo "- R = 12 (from Kâ‚„ scalar curvature)"
            echo ""
            if [ -n "$PREV_TAG" ]; then
              echo "### Changes since $PREV_TAG:"
              echo ""
              git log --no-decorate --pretty=format:'- %s (%h)' "${PREV_TAG}..HEAD"
            else
              echo "### Initial Release"
              echo ""
              echo "Complete proof: Dâ‚€ â†’ Kâ‚„ saturation â†’ G_Î¼Î½ = 8T_Î¼Î½"
            fi
            echo ""
            echo "---"
            echo "**Verification:** \`agda --safe --without-K --no-libraries DRIFE.agda\`"
            echo "**Numerical:** \`python validate_K4.py\` (7/7 tests)"
          } > CHANGELOG.md

      - name: Create source archive
        run: |
          git archive -o drife-${{ steps.sha.outputs.short }}.zip HEAD

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}
          name: DRIFE v${{ github.run_number }} (${{ steps.sha.outputs.short }})
          body_path: CHANGELOG.md
          draft: false
          prerelease: false
          files: |
            drife-${{ steps.sha.outputs.short }}.zip
